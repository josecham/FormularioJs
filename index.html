<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blox City Universe 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@700&display=swap');
        body { font-family: 'Fredoka', sans-serif; background: #00A2FF; margin: 0; overflow: hidden; touch-action: none; }
        .world { perspective: 1200px; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; transition: all 0.5s; }
        .floor { 
            width: 6000px; height: 6000px; background-color: #7cfc00;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(0,0,0,0.05) 50px),
                              repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(0,0,0,0.05) 50px);
            transform: rotateX(60deg); position: absolute;
        }
        .build-node { position: absolute; transform-style: preserve-3d; display: flex; align-items: center; justify-content: center; }
        .player { position: absolute; width: 45px; height: 70px; transform-style: preserve-3d; z-index: 1000; bottom: 45%; transition: transform 0.1s; }
        .cube { position: absolute; width: 100%; height: 100%; background: #FFD966; border: 3px solid #b5932a; }
        .interior { width: 90vw; height: 70vh; border: 10px solid #2c3e50; border-radius: 40px; position: relative; overflow: hidden; }
        .joy-stick { width: 50px; height: 50px; background: white; border-radius: 50%; position: absolute; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [view, setView] = useState('world'); // world, interior_casa, interior_escuela, interior_fabrica
            const [coins, setCoins] = useState(300);
            const [pos, setPos] = useState({ x: 0, y: 0 });
            const [city, setCity] = useState([]);
            const [showShop, setShowShop] = useState(false);
            const [isDriving, setIsDriving] = useState(false);
            const [nearObject, setNearObject] = useState(null);

            const joyData = useRef({ x: 0, y: 0, active: false });
            const coinPos = useRef({ x: 150, y: -150 });

            // Ciclo de movimiento
            useEffect(() => {
                const loop = () => {
                    if (joyData.current.active && view === 'world') {
                        setPos(prev => {
                            const speed = isDriving ? 25 : 12;
                            const nX = prev.x - joyData.current.x * speed;
                            const nY = prev.y - joyData.current.y * speed;

                            // Revisar cercan√≠a a edificios para entrar
                            let found = null;
                            city.forEach(b => {
                                const dist = Math.sqrt(Math.pow(nX + (b.rx), 2) + Math.pow(nY - (b.ry), 2));
                                if (dist < 150) found = b;
                            });
                            setNearObject(found);

                            // Recoger monedas
                            if (Math.sqrt(Math.pow(nX + coinPos.current.x, 2) + Math.pow(nY + coinPos.current.y, 2)) < 70) {
                                setCoins(c => c + 50);
                                coinPos.current = { x: Math.random() * 1200 - 600, y: Math.random() * 1200 - 600 };
                            }

                            return { x: nX, y: nY };
                        });
                    }
                    requestAnimationFrame(loop);
                };
                requestAnimationFrame(loop);
            }, [view, city, isDriving]);

            const buy = (type, price, icon) => {
                if (coins >= price) {
                    setCoins(coins - price);
                    const newB = { id: Date.now(), type, icon, rx: -pos.x, ry: pos.y };
                    setCity([...city, newB]);
                    setShowShop(false);
                }
            };

            const renderInterior = () => {
                const colors = { escuela: 'bg-orange-50', fabrica: 'bg-gray-300', casa: 'bg-yellow-50' };
                return (
                    <div className="h-screen flex flex-col items-center justify-center bg-black/80">
                        <div className={`interior ${colors[nearObject.type]} p-10 flex flex-col items-center`}>
                            <h1 className="text-4xl mb-10">EST√ÅS EN: {nearObject.type.toUpperCase()}</h1>
                            {nearObject.type === 'escuela' && <div className="text-center"><div className="text-8xl mb-4">üë®‚Äçüè´</div><div className="bg-green-800 p-4 w-64 h-32 text-white border-4 border-yellow-900">2 + 2 = 4</div></div>}
                            {nearObject.type === 'fabrica' && <div className="text-center"><div className="text-8xl animate-spin">‚öôÔ∏è</div><button onClick={() => setCoins(coins + 10)} className="mt-10 bg-blue-500 p-4 rounded-xl text-white">RECOGER DINERO üí∞</button></div>}
                            {nearObject.type === 'casa' && <div className="text-8xl">üõåüõãÔ∏èü™ë</div>}
                            <button className="absolute bottom-10 bg-red-500 text-white px-10 py-4 rounded-full font-bold" onClick={() => setView('world')}>SALIR</button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-screen w-full relative overflow-hidden bg-sky-300">
                    {view === 'world' ? (
                        <>
                            <div className="world">
                                <div className="floor" style={{ transform: `rotateX(60deg) translate3d(${pos.x}px, ${pos.y}px, 0)` }}>
                                    <div className="absolute w-12 h-12 bg-yellow-400 rounded-full border-4 border-white flex items-center justify-center shadow-lg" 
                                         style={{ left: 3000 + coinPos.current.x, top: 3000 + coinPos.current.y }}>‚≠ê</div>
                                    
                                    {city.map(b => (
                                        <div key={b.id} className="build-node" style={{ left: 3000 + b.rx, top: 3000 + b.ry }}>
                                            <div className="text-6xl" style={{ transform: 'rotateX(-60deg)' }}>{b.icon}</div>
                                        </div>
                                    ))}
                                </div>

                                <div className="player">
                                    {isDriving ? <div className="text-5xl">üöó</div> : <div className="cube"></div>}
                                </div>
                            </div>

                            {/* Bot√≥n de acci√≥n */}
                            {nearObject && (
                                <button className="absolute bottom-40 left-1/2 -translate-x-1/2 bg-yellow-400 border-4 border-white p-6 rounded-3xl font-bold text-xl shadow-2xl animate-bounce"
                                        onClick={() => {
                                            if(nearObject.type === 'auto') setIsDriving(!isDriving);
                                            else setView('interior_' + nearObject.type);
                                        }}>
                                    {nearObject.type === 'auto' ? (isDriving ? 'BAJARSE üö™' : 'CONDUCIR üèéÔ∏è') : `ENTRAR A ${nearObject.type.toUpperCase()} üö™`}
                                </button>
                            )}

                            {/* Controles UI */}
                            <div className="absolute top-6 left-6 flex flex-col gap-2">
                                <div className="bg-white border-4 border-yellow-400 px-6 py-2 rounded-full text-2xl shadow-lg">üí∞ {coins}</div>
                                <button onClick={() => setShowShop(true)} className="bg-blue-500 text-white p-4 rounded-2xl font-bold border-b-4 border-blue-800">üèóÔ∏è TIENDA</button>
                            </div>

                            {/* Joystick */}
                            <div className="absolute bottom-10 left-10 w-32 h-32 bg-black/20 rounded-full border-4 border-white/40 flex items-center justify-center"
                                 onTouchStart={() => joyData.current.active = true}
                                 onTouchMove={(e) => {
                                     const rect = e.currentTarget.getBoundingClientRect();
                                     const t = e.touches[0];
                                     const cX = rect.left + 64, cY = rect.top + 64;
                                     const dist = Math.min(50, Math.sqrt(Math.pow(t.clientX-cX,2)+Math.pow(t.clientY-cY,2)));
                                     const ang = Math.atan2(t.clientY-cY, t.clientX-cX);
                                     joyData.current.x = (Math.cos(ang)*dist)/50;
                                     joyData.current.y = (Math.sin(ang)*dist)/50;
                                 }}
                                 onTouchEnd={() => {joyData.current.active = false; joyData.current.x = 0; joyData.current.y = 0;}}>
                                <div className="joy-stick" style={{ transform: `translate(${joyData.current.x * 40}px, ${joyData.current.y * 40}px)` }}></div>
                            </div>

                            {showShop && (
                                <div className="absolute inset-0 bg-black/70 flex items-center justify-center p-6 z-[3000]">
                                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm">
                                        <h2 className="text-2xl mb-4 text-center">CIUDAD TIENDA</h2>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={() => buy('casa', 100, 'üè†')} className="bg-blue-100 p-4 rounded-xl">Casa $100</button>
                                            <button onClick={() => buy('escuela', 250, 'üè´')} className="bg-orange-100 p-4 rounded-xl">Escuela $250</button>
                                            <button onClick={() => buy('fabrica', 400, 'üè≠')} className="bg-gray-100 p-4 rounded-xl">F√°brica $400</button>
                                            <button onClick={() => buy('auto', 150, 'üöó')} className="bg-red-100 p-4 rounded-xl">Auto $150</button>
                                            <button onClick={() => buy('arbol', 20, 'üå≤')} className="bg-green-100 p-4 rounded-xl">√Årbol $20</button>
                                        </div>
                                        <button className="w-full mt-6 bg-red-500 text-white py-3 rounded-xl" onClick={() => setShowShop(false)}>CERRAR</button>
                                    </div>
                                </div>
                            )}
                        </>
                    ) : renderInterior()}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
